# Specification: CopilotKit Integration with AG-UI Protocol

## 1. Background & Context

The project currently operates a backend that hosts intelligent agents. This backend exposes a POST endpoint designed to negotiate sessions and stream events back to the client. The objective of this feature is to integrate `CopilotKit` as the frontend user interface framework to provide a rich chat and interaction experience. Crucially, the communication between this new `CopilotKit` frontend and the existing backend must utilize the `ag-ui` protocol. This ensures a standardized way of handling agent thoughts, tool calls, and responses within the new UI.

## 2. User Scenarios

- **Scenario 1: User Chat Interaction**
  - **Actor**: End User
  - **Action**: Inputs a query or command into the CopilotKit chat interface.
  - **Outcome**: The message is sent to the backend. The backend processes the request and streams back events (thoughts, text, tool acts), which are real-time rendered by CopilotKit.

- **Scenario 2: Session Initialization**
  - **Actor**: Frontend Application
  - **Action**: Application loads and initializes the CopilotKit context.
  - **Outcome**: The frontend establishes a connection/session with the backend's endpoint, readying the state for interaction.

## 3. Functional Requirements

- **FR1: User Interface Integration**
  - The application MUST provide a chat interface (e.g., Sidebar or Popup) powered by `CopilotKit`.
  - The interface MUST support real-time streaming of text and agent activities.

- **FR2: Protocol Adapter / Integration**
  - The system MUST implement a bridging mechanism that translates `CopilotKit`'s network interactions into `ag-ui` compliant event streams.
  - Incoming Server-Sent Events (SSE) from the backend, which follow `ag-ui` structure, MUST be correctly parsed and mapped to `CopilotKit`'s state (messages, intermediate steps).

- **FR3: Backend Alignment**
  - The backend endpoint MUST accept the standard payload structure generated by `CopilotKit` (e.g., `{"messages": [...]}`).
  - The backend MUST handle any necessary internal mapping from this format to the agent's logic.

## 4. Success Criteria

- **SC1**: The CopilotKit chat interface is successfully rendered on the frontend.
- **SC2**: A user can send a message, and the backend receives it without error using the standard CopilotKit payload.
- **SC3**: The backend's streaming response is visible in the UI, including final text responses.
- **SC4**: (Optional/Advanced) Intermediate agent "thoughts" or status updates streamed via `ag-ui` are visible or handled gracefully in the UI.

## 5. Key Entities

- **CopilotKit Client**: The user interface library managing chat state.
- **AG-UI Protocol**: The schema defining the event structure of messages and tools.
- **Session**: The context negotiated via the endpoint.

## 6. Assumptions

- The frontend application environment supports `CopilotKit`.
- The `ag-ui` protocol definition is established and available for reference.
- The backend is capable of parsing the standard CopilotKit message format.

## 7. Clarifications

### Session 2026-01-31

- Q: Does the backend endpoint require a specific payload structure or match CopilotKit's default?
- A: **Match CopilotKit Default**. The backend will be adapted to accept CopilotKit's standard message format to simplify frontend integration.
